name: ğŸš€ Build BulletinPro Multi-Platform

on:
  # DÃ©clenchement sur push vers main/develop
  push:
    branches: 
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  
  # DÃ©clenchement sur tags de version (v1.0.0, v2.1.3, etc.)
  push:
    tags:
      - 'v*.*.*'
  
  # DÃ©clenchement sur Pull Requests
  pull_request:
    branches: 
      - main
  
  # DÃ©clenchement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Ã  builder (ex: 1.0.0)'
        required: false
        default: '1.0.0'

# Variables d'environnement globales
env:
  APP_NAME: BulletinPro
  PYTHON_VERSION: '3.11'
  
# Permissions nÃ©cessaires pour crÃ©er des releases
permissions:
  contents: write

jobs:
  # ========================================
  # JOB 1 : BUILD WINDOWS
  # ========================================
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout du code source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # NÃ©cessaire pour git describe
    
    - name: ğŸ Installation de Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: ğŸ“¦ Installation des dÃ©pendances Python
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pillow  # S'assurer que Pillow est installÃ©
      shell: pwsh
    
    - name: ğŸ–¼ï¸ GÃ©nÃ©ration des icÃ´nes (Windows)
      run: |
        echo "GÃ©nÃ©ration des icÃ´nes depuis logo.png..."
        python scripts/create_icons.py
        
        # VÃ©rification que les icÃ´nes sont crÃ©Ã©es
        if (Test-Path "assets/icons/app_icon.ico") {
          echo "âœ… IcÃ´ne Windows crÃ©Ã©e avec succÃ¨s"
        } else {
          echo "âŒ Erreur : IcÃ´ne Windows manquante"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ”¨ Compilation avec PyInstaller (Windows)
      run: |
        echo "Compilation de BulletinPro.exe..."
        
        pyinstaller --noconfirm --clean `
          --name "BulletinPro" `
          --windowed `
          --onefile `
          --icon "assets/icons/app_icon.ico" `
          --add-data "config.py;." `
          --add-data ".env;." `
          --add-data "assets/icons;assets/icons" `
          --hidden-import "flet" `
          --hidden-import "flet.core" `
          --hidden-import "flet.utils" `
          --hidden-import "fpdf" `
          --hidden-import "fpdf.fonts" `
          --hidden-import "fpdf.html" `
          --hidden-import "supabase" `
          --hidden-import "postgrest" `
          --hidden-import "sqlite3" `
          --hidden-import "PIL" `
          --hidden-import "PIL.Image" `
          --exclude-module "tkinter" `
          --exclude-module "matplotlib" `
          --exclude-module "numpy" `
          --exclude-module "pandas" `
          main.py
        
        # VÃ©rification de la compilation
        if (Test-Path "dist/BulletinPro.exe") {
          echo "âœ… ExÃ©cutable Windows crÃ©Ã© : $(Get-Item 'dist/BulletinPro.exe' | Select-Object -ExpandProperty Length) bytes"
        } else {
          echo "âŒ Erreur : ExÃ©cutable Windows manquant"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ“¦ PrÃ©paration de la structure pour Inno Setup
      run: |
        echo "PrÃ©paration de la structure d'installation..."
        python scripts/build_windows.py
      shell: pwsh
    
    - name: ğŸ› ï¸ Installation de Inno Setup
      run: |
        echo "Installation de Inno Setup via Chocolatey..."
        choco install innosetup -y --no-progress
        
        # VÃ©rification de l'installation
        $innoPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (Test-Path $innoPath) {
          echo "âœ… Inno Setup installÃ© : $innoPath"
        } else {
          echo "âŒ Erreur : Inno Setup non trouvÃ©"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ CrÃ©ation de l'installateur Windows
      run: |
        echo "Compilation de l'installateur avec Inno Setup..."
        
        $innoCompiler = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        
        # VÃ©rifier que le fichier .iss existe
        if (-not (Test-Path "installer/windows.iss")) {
          echo "âŒ Erreur : fichier installer/windows.iss manquant"
          exit 1
        }
        
        # Compiler l'installateur
        & $innoCompiler "installer/windows.iss"
        
        # VÃ©rifier le rÃ©sultat
        $installerPath = Get-ChildItem "dist/installers/BulletinPro_Setup_*.exe" | Select-Object -First 1
        if ($installerPath) {
          echo "âœ… Installateur crÃ©Ã© : $($installerPath.Name) - $($installerPath.Length) bytes"
        } else {
          echo "âŒ Erreur : Installateur non crÃ©Ã©"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ“¤ Upload de l'installateur Windows
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Windows-Installer
        path: dist/installers/BulletinPro_Setup_*.exe
        retention-days: 30
        if-no-files-found: error
    
    - name: ğŸ“¤ Upload de l'exÃ©cutable portable Windows
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Windows-Portable
        path: dist/BulletinPro.exe
        retention-days: 30
        if-no-files-found: error

  # ========================================
  # JOB 2 : BUILD LINUX (Ubuntu/Debian)
  # ========================================
  build-linux:
    name: ğŸ§ Build Linux
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout du code source
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Installation de Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'requirements.txt'
    
    - name: ğŸ“¦ Installation des dÃ©pendances systÃ¨me (Linux)
      run: |
        echo "Installation des bibliothÃ¨ques systÃ¨me..."
        sudo apt-get update -qq
        sudo apt-get install -y \
          libgtk-3-0 \
          libnotify4 \
          libgstreamer1.0-0 \
          libgstreamer-plugins-base1.0-0 \
          libgstreamer-plugins-bad1.0-0 \
          libnss3 \
          libxss1 \
          libasound2 \
          libxtst6 \
          xauth \
          xvfb \
          dpkg-dev \
          fakeroot \
          > /dev/null
        
        echo "âœ… DÃ©pendances systÃ¨me installÃ©es"
    
    - name: ğŸ“¦ Installation des dÃ©pendances Python
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pillow
        echo "âœ… DÃ©pendances Python installÃ©es"
    
    - name: ğŸ–¼ï¸ GÃ©nÃ©ration des icÃ´nes (Linux)
      run: |
        echo "GÃ©nÃ©ration des icÃ´nes depuis logo.png..."
        python scripts/create_icons.py
        
        # VÃ©rification
        if [ -f "assets/icons/app_icon.png" ]; then
          echo "âœ… IcÃ´nes Linux crÃ©Ã©es avec succÃ¨s"
          ls -lh assets/icons/
        else
          echo "âŒ Erreur : IcÃ´nes manquantes"
          exit 1
        fi
    
    - name: ğŸ”¨ Compilation avec PyInstaller (Linux)
      run: |
        echo "Compilation du binaire Linux..."
        
        pyinstaller --noconfirm --clean \
          --name "bulletinpro" \
          --windowed \
          --onefile \
          --icon "assets/icons/app_icon.png" \
          --add-data "config.py:." \
          --add-data ".env:." \
          --add-data "assets/icons:assets/icons" \
          --hidden-import "flet" \
          --hidden-import "flet.core" \
          --hidden-import "flet.utils" \
          --hidden-import "fpdf" \
          --hidden-import "fpdf.fonts" \
          --hidden-import "fpdf.html" \
          --hidden-import "supabase" \
          --hidden-import "postgrest" \
          --hidden-import "sqlite3" \
          --hidden-import "PIL" \
          --hidden-import "PIL.Image" \
          --exclude-module "tkinter" \
          --exclude-module "matplotlib" \
          main.py
        
        # VÃ©rification
        if [ -f "dist/bulletinpro" ]; then
          echo "âœ… Binaire Linux crÃ©Ã© : $(stat -c%s dist/bulletinpro) bytes"
          chmod +x dist/bulletinpro
        else
          echo "âŒ Erreur : Binaire Linux manquant"
          exit 1
        fi
    
    - name: ğŸ“¦ CrÃ©ation de la structure .deb
      run: |
        echo "CrÃ©ation de la structure du package .deb..."
        python scripts/build_linux.py
        echo "âœ… Structure .deb prÃªte"
    
    - name: ğŸ Build du package .deb
      run: |
        echo "Construction du package .deb..."
        cd dist
        
        # VÃ©rifier la structure
        if [ ! -d "bulletinpro-1.0.0" ]; then
          echo "âŒ Erreur : Dossier bulletinpro-1.0.0 manquant"
          exit 1
        fi
        
        # Construire le .deb
        dpkg-deb --build bulletinpro-1.0.0
        
        # Renommer pour clartÃ©
        mv bulletinpro-1.0.0.deb BulletinPro-1.0.0-amd64.deb
        
        # VÃ©rification
        if [ -f "BulletinPro-1.0.0-amd64.deb" ]; then
          echo "âœ… Package .deb crÃ©Ã© : $(stat -c%s BulletinPro-1.0.0-amd64.deb) bytes"
          dpkg-deb --info BulletinPro-1.0.0-amd64.deb
        else
          echo "âŒ Erreur : Package .deb manquant"
          exit 1
        fi
    
    - name: ğŸ“¤ Upload du package .deb
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Linux-DEB
        path: dist/BulletinPro-*.deb
        retention-days: 30
        if-no-files-found: error
    
    - name: ğŸ“¤ Upload du binaire Linux
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Linux-Binary
        path: dist/bulletinpro
        retention-days: 30
        if-no-files-found: error

  # ========================================
  # JOB 3 : CRÃ‰ATION DE RELEASE GITHUB
  # (uniquement si tag v*.*.*)
  # ========================================
  create-release:
    name: ğŸ‰ CrÃ©ation de la Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ TÃ©lÃ©chargement - Installateur Windows
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Windows-Installer
        path: ./release
    
    - name: ğŸ“¥ TÃ©lÃ©chargement - Portable Windows
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Windows-Portable
        path: ./release
    
    - name: ğŸ“¥ TÃ©lÃ©chargement - Package Linux
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Linux-DEB
        path: ./release
    
    - name: ğŸ“¥ TÃ©lÃ©chargement - Binaire Linux
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Linux-Binary
        path: ./release
    
    - name: ğŸ“ Affichage des fichiers Ã  publier
      run: |
        echo "ğŸ“¦ Fichiers de la release :"
        ls -lh ./release/
    
    - name: ğŸ‰ CrÃ©ation de la Release GitHub
      uses: softprops/action-gh-release@v2
      with:
        files: ./release/*
        body: |
          ## ğŸ‰ BulletinPro ${{ github.ref_name }}
          
          ### ğŸ“¥ TÃ©lÃ©chargements
          
          #### ğŸªŸ **Windows**
          - **`BulletinPro_Setup_*.exe`** : Installateur complet (recommandÃ©)
            - Double-clic pour installer
            - IcÃ´ne sur le bureau et menu DÃ©marrer
            - DÃ©sinstallation propre via Panneau de configuration
          
          - **`BulletinPro.exe`** : Version portable
            - Aucune installation requise
            - Lancez directement l'exÃ©cutable
          
          #### ğŸ§ **Linux (Ubuntu/Debian)**
          - **`BulletinPro-*-amd64.deb`** : Package Debian (recommandÃ©)
```bash
            sudo dpkg -i BulletinPro-1.0.0-amd64.deb
```
            - Installation systÃ¨me complÃ¨te
            - IcÃ´ne dans le menu Applications
          
          - **`bulletinpro`** : Binaire standalone
```bash
            chmod +x bulletinpro
            ./bulletinpro
```
          
          ---
          
          ### âœ¨ NouveautÃ©s de cette version
          
          - ğŸ¨ Interface utilisateur moderne et intuitive
          - ğŸ“Š Gestion complÃ¨te des bulletins scolaires
          - ğŸ‘¥ Support multi-utilisateurs (Admin/Professeur)
          - ğŸ“ˆ Statistiques dÃ©taillÃ©es par classe/Ã©lÃ¨ve
          - ğŸ–¨ï¸ GÃ©nÃ©ration automatique de PDF professionnels
          - â˜ï¸ Synchronisation cloud via Supabase
          - ğŸ” SystÃ¨me d'authentification sÃ©curisÃ©
          
          ---
          
          ### ğŸ“‹ Configuration Requise
          
          **Windows** :
          - Windows 10/11 (64-bit)
          - 4 GB RAM minimum
          - 500 MB espace disque
          
          **Linux** :
          - Ubuntu 20.04+ / Debian 11+
          - Architecture x86_64
          - GTK 3.0+
          
          ---
          
          ### ğŸ› Bugs Connus
          
          Aucun bug critique identifiÃ© pour cette version.
          
          Pour signaler un problÃ¨me : [Issues GitHub](https://github.com/${{ github.repository }}/issues)
          
          ---
          
          ### ğŸ“š Documentation
          
          Consultez le [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) pour le guide d'utilisation complet.
          
          ---
          
          **Build automatique via GitHub Actions** âœ…  
          Date : ${{ github.event.head_commit.timestamp }}  
          Commit : `${{ github.sha }}`
        draft: false
        prerelease: false
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================
  # JOB 4 : NOTIFICATION (optionnel)
  # ========================================
  notify-success:
    name: ğŸ“¢ Notification de succÃ¨s
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸ‰ Build rÃ©ussi
      run: |
        echo "âœ… Build BulletinPro terminÃ© avec succÃ¨s !"
        echo "ğŸ“¦ Windows : Installateur + Portable"
        echo "ğŸ“¦ Linux : Package .deb + Binaire"
        echo ""
        echo "ğŸ“¥ TÃ©lÃ©chargez les artifacts depuis l'onglet Actions"
```

---

## ğŸ“ **Structure ComplÃ¨te du Projet**

Voici comment organiser vos fichiers :
```
BulletinPro/
â”‚
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/
â”‚       â””â”€â”€ build.yml                    â† â­ CE FICHIER
â”‚
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ icons/
â”‚       â””â”€â”€ logo.png                     â† VOTRE LOGO BLEU ICI
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ create_icons.py                  â† GÃ©nÃ¨re les icÃ´nes
â”‚   â”œâ”€â”€ build_windows.py                 â† PrÃ©pare Windows
â”‚   â””â”€â”€ build_linux.py                   â† PrÃ©pare Linux
â”‚
â”œâ”€â”€ installer/
â”‚   â””â”€â”€ windows.iss                      â† Config Inno Setup
â”‚
â”œâ”€â”€ main.py                              â† Point d'entrÃ©e
â”œâ”€â”€ config.py                            â† Configuration
â”œâ”€â”€ sync_manager.py                      â† Gestion Supabase
â”œâ”€â”€ Bulletin.py                          â† GÃ©nÃ©ration bulletins
â”œâ”€â”€ Page0.py, Page1.py, ...              â† Autres modules
â”‚
â”œâ”€â”€ requirements.txt                     â† â­ CE FICHIER
â”œâ”€â”€ .env                                 â† Variables (ne pas commit)
â”œâ”€â”€ .gitignore                           â† Fichiers Ã  ignorer
â”œâ”€â”€ LICENSE.txt                          â† Licence
â””â”€â”€ README.md                            â† Documentation
