name: ğŸš€ Build BulletinPro Multi-Platform (UnifiÃ©)

on:
  push:
    branches: 
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches: 
      - main
  workflow_dispatch:

env:
  APP_NAME: BulletinPro
  PYTHON_VERSION: '3.11'

permissions:
  contents: write

jobs:
  build-windows:
    name: ğŸªŸ Build Windows
    runs-on: windows-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pillow pyinstaller
      shell: pwsh
    
    - name: ğŸ–¼ï¸ Generate icons
      run: python scripts/create_icons.py
      shell: pwsh
    
    - name: ğŸ”¨ Build with PyInstaller
      run: |
        pyinstaller --noconfirm --clean `
          --name "BulletinPro" `
          --windowed `
          --onefile `
          --icon "assets/icons/app_icon.ico" `
          --add-data "config.py;." `
          --add-data "assets/icons;assets/icons" `
          --hidden-import "flet" `
          --hidden-import "flet.core" `
          --hidden-import "flet_core" `
          --hidden-import "flet_runtime" `
          --hidden-import "fpdf" `
          --hidden-import "supabase" `
          --hidden-import "PIL" `
          --hidden-import "sqlite3" `
          --collect-all flet `
          --collect-all flet_core `
          --collect-all flet_runtime `
          main.py
      shell: pwsh
    
    - name: âœ… Verify build
      run: |
        if (Test-Path dist/BulletinPro.exe) {
          Write-Host "âœ… Executable created"
          $size = (Get-Item dist/BulletinPro.exe).Length / 1MB
          Write-Host "ğŸ“¦ Size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ Build failed"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ“¦ Prepare installer structure
      run: python scripts/build_windows.py
      shell: pwsh
    
    - name: ğŸ› ï¸ Install Inno Setup
      run: choco install innosetup -y --no-progress
      shell: pwsh
    
    - name: ğŸ Create installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/windows.iss
      shell: pwsh
    
    - name: ğŸ“¤ Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Windows-Installer
        path: dist/installers/BulletinPro_Setup_*.exe
        retention-days: 90
    
    - name: ğŸ“¤ Upload Windows portable
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Windows-Portable
        path: dist/BulletinPro.exe
        retention-days: 90

  build-linux:
    name: ğŸ§ Build Linux
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          libgtk-3-0 \
          libnotify4 \
          libgstreamer1.0-0 \
          libgstreamer-plugins-base1.0-0 \
          dpkg-dev \
          fakeroot \
          patchelf
    
    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pillow pyinstaller staticx
    
    - name: ğŸ–¼ï¸ Generate icons
      run: python scripts/create_icons.py
    
    - name: ğŸ”¨ Build with PyInstaller
      run: |
        pyinstaller --noconfirm --clean \
          --name "bulletinpro" \
          --windowed \
          --onefile \
          --icon "assets/icons/app_icon.png" \
          --add-data "config.py:." \
          --add-data "assets/icons:assets/icons" \
          --hidden-import "flet" \
          --hidden-import "flet.core" \
          --hidden-import "flet_core" \
          --hidden-import "flet_runtime" \
          --hidden-import "fpdf" \
          --hidden-import "supabase" \
          --hidden-import "PIL" \
          --hidden-import "sqlite3" \
          --collect-all flet \
          --collect-all flet_core \
          --collect-all flet_runtime \
          main.py
    
    - name: ğŸ”§ Make static binary (fix ncurses issue)
      run: |
        # StaticX rend le binaire portable en embarquant toutes les libs
        staticx dist/bulletinpro dist/bulletinpro-static
        mv dist/bulletinpro-static dist/bulletinpro
        chmod +x dist/bulletinpro
    
    - name: âœ… Verify build
      run: |
        if [ -f dist/bulletinpro ]; then
          echo "âœ… Executable created"
          ls -lh dist/bulletinpro
          file dist/bulletinpro
          ldd dist/bulletinpro || echo "Static binary (no dependencies)"
        else
          echo "âŒ Build failed"
          exit 1
        fi
    
    - name: ğŸ“¦ Create DEB structure
      run: python scripts/build_linux.py
    
    - name: ğŸ Build DEB package
      run: |
        cd dist
        dpkg-deb --build bulletinpro-1.0.0
        mv bulletinpro-1.0.0.deb BulletinPro-1.0.0-amd64.deb
    
    - name: ğŸ“¤ Upload Linux DEB
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Linux-DEB
        path: dist/BulletinPro-*.deb
        retention-days: 90
    
    - name: ğŸ“¤ Upload Linux binary
      uses: actions/upload-artifact@v4
      with:
        name: BulletinPro-Linux-Binary
        path: dist/bulletinpro
        retention-days: 90

  create-release:
    name: ğŸ‰ Create Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Windows installer
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Windows-Installer
        path: ./release/windows
    
    - name: ğŸ“¥ Download Windows portable
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Windows-Portable
        path: ./release/windows-portable
    
    - name: ğŸ“¥ Download Linux DEB
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Linux-DEB
        path: ./release/linux
    
    - name: ğŸ“¥ Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Linux-Binary
        path: ./release/linux-binary
    
    - name: ğŸ”’ Create checksums
      run: |
        cd release
        find . -type f -exec sha256sum {} \; > checksums.txt
    
    - name: ğŸ‰ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ./release/windows/*
          ./release/windows-portable/*
          ./release/linux/*
          ./release/linux-binary/*
          ./release/checksums.txt
        body: |
          ## ğŸ‰ BulletinPro ${{ github.ref_name }}
          
          ### ğŸ“¥ TÃ©lÃ©chargements
          
          **Windows**
          - ğŸ”§ Installateur complet : `BulletinPro_Setup_*.exe` (recommandÃ©)
          - ğŸ’¼ Version portable : `BulletinPro.exe`
          
          **Linux**
          - ğŸ“¦ Package Debian/Ubuntu : `BulletinPro-*-amd64.deb` (recommandÃ©)
          - ğŸ’¼ Binaire portable : `bulletinpro` (statique, fonctionne partout)
          
          ### ğŸš€ Installation
          
          **Windows**
          - Double-clic sur `BulletinPro_Setup_*.exe`
          - Ou lancez directement `BulletinPro.exe` (portable)
          
          **Linux (DEB)**
          ```bash
          sudo dpkg -i BulletinPro-*.deb
          bulletinpro
          ```
          
          **Linux (Binaire)**
          ```bash
          chmod +x bulletinpro
          ./bulletinpro
          ```
          
          ### ğŸ”’ VÃ©rification d'intÃ©gritÃ©
          VÃ©rifiez les checksums SHA256 dans `checksums.txt`
          
          ### âœ¨ NouveautÃ©s
          - PremiÃ¨re version stable
          - Gestion complÃ¨te des bulletins scolaires
          - Synchronisation cloud avec Supabase
          - Build unifiÃ© multi-plateforme
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-builds:
    name: ğŸ§ª Test Builds
    needs: [build-windows, build-linux]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-22.04]
    
    steps:
    - name: ğŸ“¥ Download artifact (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Windows-Portable
    
    - name: ğŸ“¥ Download artifact (Linux)
      if: matrix.os == 'ubuntu-22.04'
      uses: actions/download-artifact@v4
      with:
        name: BulletinPro-Linux-Binary
    
    - name: ğŸ§ª Test executable exists (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        if (Test-Path BulletinPro.exe) {
          Write-Host "âœ… Windows executable OK"
          Get-Item BulletinPro.exe | Select-Object Name, Length
        } else {
          Write-Host "âŒ Executable not found"
          exit 1
        }
      shell: pwsh
    
    - name: ğŸ§ª Test executable exists (Linux)
      if: matrix.os == 'ubuntu-22.04'
      run: |
        if [ -f bulletinpro ]; then
          echo "âœ… Linux executable OK"
          ls -lh bulletinpro
          file bulletinpro
          # VÃ©rifier les dÃ©pendances
          ldd bulletinpro || echo "âœ… Static binary (no deps)"
        else
          echo "âŒ Executable not found"
          exit 1
        fi
